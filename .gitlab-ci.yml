image: ubuntu:16.04

stages:
 - test
 - allure

default:
  tags:
    - ubuntu


before_script:
      - apt-get update -y
      - apt install curl zip unzip wget -y
      - wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | apt-key add -
      - echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" > /etc/apt/sources.list.d/google-chrome.list
      - apt-get update
      - wget http://archive.ubuntu.com/ubuntu/pool/main/libu/libu2f-host/libu2f-udev_1.1.4-1_all.deb
      - dpkg -i libu2f-udev_1.1.4-1_all.deb
      - apt -y install libnss3
      - apt -y install google-chrome-stable -y
      - curl -s "https://get.sdkman.io" | bash
      - source "$HOME/.sdkman/bin/sdkman-init.sh"
      - sdk version
      - sdk ls java
      - sdk install java 11.0.7-open

test-stage:
    stage: test
    allow_failure: true
    script:
        - ./gradlew -x test uiTests
    artifacts:
      when: always
      paths:
        - build/allure-results

Allure report:
  stage: allure
  script:
    - ./gradlew allureReport
    - echo "Allure report live here - https://${CI_PROJECT_NAMESPACE}.${CI_PAGES_DOMAIN}/-/${CI_PROJECT_NAME}/-/jobs/${CI_JOB_ID}/artifacts/build/reports/allure-report/allureReport/index.html"
  artifacts:
    when: always
    paths:
      - build/reports/allure-report/allureReport/*


# #Образ для градл
# image: gradle:alpine

# #image: maven:3.8-openjdk-11

# default:
#   tags:
#     - shelllocal

# stages:
#   - tests
#   - allure

# API Test:
#   stage: tests
#   allow_failure: true
#   script:
#     - ./gradlew -x test apiTests
#   artifacts:
#     when: always
#     paths:
#       - build/allure-results

# UI Test:
#   stage: tests
#   allow_failure: true
#   script:
#     - ./gradlew -x test uiTests
#   artifacts:
#     when: always
#     paths:
#       - build/allure-results

# Allure report:
#   stage: allure
#   script:
#     - ./gradlew allureReport
#     - echo "Allure report live here - https://${CI_PROJECT_NAMESPACE}.${CI_PAGES_DOMAIN}/-/${CI_PROJECT_NAME}/-/jobs/${CI_JOB_ID}/artifacts/build/reports/allure-report/allureReport/index.html"
#   artifacts:
#     when: always
#     paths:
#       - build/reports/allure-report/allureReport/*


# #Integration tests with Allure:
# #  stage: test
# #  script:
# #    - ./gradlew clean test
# #  after_script:
# #    - ./gradlew allureReport
# #  artifacts:
# #    when: always
# #    paths:
# #      - build/reports/allure-report/allureReport/*